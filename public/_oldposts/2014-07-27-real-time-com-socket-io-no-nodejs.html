---
layout: post
title: Real-time com Socket.IO no Node.js
tags: Node.js
keywords: Node.js, Real-time, Socket.IO, WebSockets
published: true
description: Que tal implementar um simples contador de visitas real-time em seu site usando Node.js e Socket.IO?
---
<figure class="post-image">
  <img src="{{ site.url }}/images/socket-io.jpg" width="239" height="114" alt="Real-time com Socket.IO" title="Real-time com Socket.IO">
  <figcaption>Real-time com Socket.IO (Post atualizado com Socket.IO 1.0)</figcaption>
</figure>
<div class="post-content">
  <p>Que tal implementar um simples contador de visitas que apresenta em <strong>tempo real</strong> o número de visitantes online, e seu respectivo browser e sistema operacional em seu site?</p>
	<p>Você pode fazer isso, utilizando Node.js e um módulo chamado: <strong>Socket.IO</strong>. O Socket.IO permite realizar comunicação bidirecional utilizando uma das APIs de transporte na seguinte ordem: <strong>WebSockets, FlashSockets, AJAX long polling, AJAX multipart streaming, Forever Iframe ou JSONP Polling</strong>. O motivo dessa ordem é garantir compatibilidade cross-browser.</p>
	<p>Na prática o <strong>Socket.IO</strong> abre uma conexão com servidor pelo qual possibilita realizar troca de mensagens entre ambos sem a necessidade de dar um refresh na página, ou seja, sem a necessidade de solicitar uma nova request para o servidor. Com isso é possível explorar o conceito de <strong>real-time</strong> em uma aplicação, pelo qual basicamente o cliente envia uma mensagem e o servidor processa e responde via <strong>broadcast</strong> (para todos os clientes de conexão aberta com servidor) através de um <strong>long pooling de conexão</strong>.</p>

	<p>Esse conceito é muito aplicado em aplicações de geração de relatórios em tempo real, chats, jogos multiplayer online, aplicações de interação em tempo real com diversos usuários <strong>(Google Docs, Facebook, Twitter são exemplo disso)</strong> e muito mais.</p>

  {% include content-ads.ext %}

	<p>Abaixo apresentarei como criar um simples contador de usuários online. Para isso instale o Socket.IO:</p>

{% highlight bash %}
npm install socket.io --save
{% endhighlight %}

  <p>Em seguida crie o backend da aplicação <strong>(app.js)</strong> com o seguite código:</p>

{% highlight javascript %}
// Servidor: app.js
// Iniciando servidor HTTP
var app = require('http').createServer(index)
  , io = require('socket.io').listen(app)
  , fs = require('fs')
;
app.listen(3000, function() {
  console.log("Servidor rodando!");
});

function index(req, res){
  fs.readFile(__dirname + '/index.html', function(err, data){
	  res.writeHead(200);
    res.end(data);
  });
};

// Iniciando Socket.IO
var visitas = 0;
// Evento connection ocorre quando entra um novo usuário.
io.on('connection', function(socket){
  // Incrementa o total de visitas no site.
  visitas++;
  // Envia o total de visitas para o novo usuário.
  socket.emit('visits', visitas);
  // Envia o total de visitas para os demais usuários.
  socket.broadcast.emit('visits', visitas);

  // Evento disconnect ocorre quando sai um usuário.
  socket.on('disconnect', function(){
    visitas--;
    // Atualiza o total de visitas para os demais usuários.
    socket.broadcast.emit('message', visitas);
  });
});
{% endhighlight %}

	<p>Resumindo, criei um servidor para ler um arquivo index.html em sua rota principal, instanciei e configurei dois eventos do <strong>Socket.IO</strong> pelo qual utilizei o evento padrão <strong>"disconnect"</strong> e criei um evento chamado <strong>"visits"</strong>, ambos os eventos trabalham a variável <strong>visitas</strong>, incrementando o valor quando surgir um novo usuário e decrementando quando um usuário sair da página. Por fim, o Socket.IO envia para o cliente o total de visitas através dos métodos: <strong>socket.emit()</strong> que envia o total de visitas para o usuário atual, e <strong>socket.broadcast.emit()</strong> que envia o total de visitas para todos os demais usuários.</p>

	<p>Agora no lado cliente, crie a página <strong>index.html</strong>, adicione o scripts do cliente socket.io: <strong>"/socket.io/socket.io.js"</strong> na tag script, e faça o seguinte código:</p>

{% highlight javascript %}
<html>
  <head>
    <script src=/socket.io/socket.io.js></script>
    <script>
    var socket = io('http://localhost:3000');
    socket.on('visits', function(visitas){
      document.getElementById('visitas').innerHTML = visitas;
    });
    </script>
  </head>
  <body>
    <p>Contador de visitas online com Socket.io</p>
    <p>Número de visitas: <span id="visitas">0</span></p>
  </body>
</html>
{% endhighlight %}

  <p>Após incluir o scripts do cliente Socket.IO, executamos a função: <strong>var socket = io('http://localhost:3000')</strong> que inicia uma conexão com o servidor. Esta conexão inicia o evento <strong>io.on('connection')</strong> e lá atualizamos o total de visitas e emitimos o evento <strong>socket.emit('visits')</strong>, pelo qual tratamos este evento no cliente através da função <strong>socket.on('visits')</strong> que recebe em seu callback o total de visitas e atualiza na página do site.</p>

  <p>Para testar esse app, basta rodar o comando:</p>

{% highlight bash %}
node app.js
{% endhighlight %}

  <p>Em seguida acesse em vários browsers ou abas do mesmo browser (para simular múltiplos usuários acessando o site) o endereço: <strong>http://localhost:3000</strong></p>

  <p>Esta foi uma simples demonstração do poder real-time oferecido pelo <a href="{{site.url}}/nodejs">Node.js</a> com <strong>Socket.IO</strong>.</p>

	<p>Para melhores referências, recomendo que estude a fundo o Socket.IO através de seu site oficial: <a href="http://socket.io/" title="Site oficial do Socket.io" target="_blank">http://socket.io</a></p>



</div>
