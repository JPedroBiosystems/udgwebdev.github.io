---
layout: post
title: Evitando Callback Hell usando Generators
tags: Node.js
keywords: Node.js, Generators, ECMA6, ECMAScript6
published: true
description: Generators é um recurso muito interessante que permite escrever funções assíncronas sem callbacks, utilizando uma síntaxe de código síncrono, retornando valores da função em um array que representa as variáveis do parâmetro de um callback.
image_url: javascript-logo.jpg
---
<figure class="post-image">
  <img src="{{ site.url }}/images/javascript-logo.jpg" width="250" height="250" alt="Evitando Callback Hell usando Generators" title="Evitando Callback Hell usando Generators">
  <figcaption>Evitando Callback Hell usando Generators</figcaption>
</figure>
<div class="post-content">
  <p>Muitos recursos interessantes estão surgindo do ECMAScript6 para o Javascript, o Generators é um deles e será o assunto desse post.</p>
  <p>Em resumo generators é um recurso muito interessante que permite escrever funções assíncronas sem callbacks, utilizando uma síntaxe de código síncrono, <strong>retornando valores da função em um array que representa as variáveis do parâmetro de uma função callback</strong>.</p>
  <p>Como essa feature ainda não é oficial, somente alguns browser (últimas versões do Chrome e Firefox) utilizam no client-side. Já no server-side temos que habilitar no Node.js, porém só existe nas versões instáveis: <strong>0.11.X.</strong> e será oficializada na próxima versão estável: <strong>0.12.x</strong>.</p>
  <p>Caso queira brincar com versões instáveis de forma simples e de fácil instalação/desinstalação, veja neste post como utilizar o <a href="{{site.url}}/nvm-node-version-manager" target="_blank" title="NVM - Node Version Manager">NVM - Node Version Manager</a>.</p>
  <p>Para habilitá-lo no Node.js, basta utilizar a flag <code>--harmony</code> no comando <code>node</code>, por exemplo:</p>

{% highlight bash %}
node --harmony app.js
{% endhighlight %}

  <p>Com harmony habilitado, agora teremos que usar alguma <strong>biblioteca de controle async</strong>. Utilizarei o <a href="https://github.com/jmar777/suspend" target="_blank">suspend</a> que é um módulo fácil de implementar generators.</p>
  <p>Abaixo mostrarei dois códigos que fazem a mesma coisa, o primeiro utilizando callbacks e o segundo implementando generators, veja a diferença:</p>

<h2>Usando callbacks</h2>
{% highlight javascript %}
var
  fs = require("fs"),
  time = new Date().getTime()
;
fs.writeFile("log.txt", time, function(err) {
  console.log("Iniciando log");

  fs.readFile("log.txt", function(err, text) {
    console.log("Timestamp: " + text);

    fs.unlink("log.txt", function() {
      console.log("Log finalizado");
    });

  });

});
{% endhighlight %}

<h2>Usando generators</h2>

<p>Instale o módulo suspend:</p>

{% highlight bash %}
npm install suspend --save
{% endhighlight %}

{% highlight javascript %}
var
  fs = require('fs'),
  suspend = require('suspend'),
  resume = suspend.resume,
  time = new Date().getTime()
;
suspend(function* (){

  yield fs.writeFile("log.txt", time, resume());
  console.log("Iniciando log");

  var text = yield fs.readFile("log.txt", resume());
  console.log("Timestamp" + text);

  yield fs.unlink("log.txt", resume());
  console.log("Log finalizado");

})();
{% endhighlight %}

  {% include content-ads.ext %}

  <p>Referências:<br>
    <ul>
      <li><a href="https://github.com/jmar777/suspend" target="_blank" title="Github do Suspend">Github do Suspend</a></li>
      <li><a href="http://caba.re/usando-generators-para-botar-a-casa-em-ordem" target="_blank" title="Usando generators para botar a casa em ordem">Cabaré - Usando generators para botar a casa em ordem</a></li>
      <li><a href="http://howtonode.org/generators-vs-fibers" target="_blank" title="How to Node - Generators vs Fibers">How to Node - Generators vs Fibers</a></li>
      <li><a href="http://jlongster.com/2012/10/05/javascript-yield.html" target="_blank" title="Javascript's Future: Generators">James Long - Javascript's Future: Generators</a></li>
    </ul>
  </p>
</div>
