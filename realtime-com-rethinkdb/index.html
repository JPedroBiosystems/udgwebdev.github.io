<!DOCTYPE html><html lang="en" manifest="/manifest.appcache" xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://ogp.me/ns#"><head><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/><meta charset="utf-8"/><title>Realtime com RethinkDB | Underground WebDev</title><meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#BA2D27"/><meta name="apple-mobile-web-app-title" content="UDGWebDev"/><meta name="msapplication-TileImage" content="https://udgwebdev.com/images/undefined-128.png"/><meta name="msapplication-TileColor" content="#BA2D27"/><meta name="msapplication-tap-highlight" content="no"/><meta name="mobile-web-app-capable" content="yes"/><meta name="application-name" content="UDGWebDev"/><meta name="theme-color" content="#BA2D27"/><meta name="title" content="Realtime com RethinkDB"/><meta name="author" content="Caio Ribeiro Pereira"/><meta name="description" content="Se você precisa de um banco NoSQL que trabalhe com JSON, tenha suporte a consultas realtime e você quer expandir seus horizontes em conhecimentos que vão além de trabalhar apenas com MongoDB, uma boa opção é conhecer o RethinkDB."/><meta property="og:title" content="Realtime com RethinkDB"/><meta property="og:description" content="Se você precisa de um banco NoSQL que trabalhe com JSON, tenha suporte a consultas realtime e você quer expandir seus horizontes em conhecimentos que vão além de trabalhar apenas com MongoDB, uma boa opção é conhecer o RethinkDB."/><meta property="og:url" content="https://udgwebdev.com/realtime-com-rethinkdb"/><meta property="og:site_name" content="Underground WebDev"/><meta property="og:image" content="https://udgwebdev.com/images/rethinkdb-logo.png"/><meta property="og:type" content="website"/><meta property="article:author" content="https://plus.google.com/+CaioRibeiroPereira"/><meta property="article:section" content="main"/><meta name="twitter:creator" content="@crp_underground"/><meta name="twitter:card" content="summary"/><meta name="twitter:url" content="https://udgwebdev.com/realtime-com-rethinkdb"/><meta name="twitter:title" content="Realtime com RethinkDB"/><meta name="twitter:description" content="Se você precisa de um banco NoSQL que trabalhe com JSON, tenha suporte a consultas realtime e você quer expandir seus horizontes em conhecimentos que vão além de trabalhar apenas com MongoDB, uma boa opção é conhecer o RethinkDB."/><meta name="twitter:image" content="https://udgwebdev.com/images/rethinkdb-logo.png"/><link rel="manifest" href="/manifest.json"/><link rel="stylesheet" href="/assets/css/main.css" type="text/css"/><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/><link rel="canonical" href="https://udgwebdev.com/realtime-com-rethinkdb"/></head><body><nav role="navigation" class="navbar navbar-inverse navbar-fixed-top"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand"><img src="/images/udgwebdev-logo.png" alt="Underground WebDev" width="48" class="navbar-logo"/></a></div><div class="navbar-right navbar-collapse collapse"><ul class="nav navbar-nav"><li><a href="/nodejs"><i class="fa fa-code"></i>&nbsp;Node.js</a></li><li><a href="/meteor"><i class="fa fa-code"></i>&nbsp;Meteor</a></li><li><a href="/dicas-de-terminal"><i class="fa fa-terminal"></i>&nbsp;Terminal</a></li></ul></div></div></nav><nav role="navigation" class="c-circle-menu js-menu"><button class="c-circle-menu__toggle js-menu-toggle"><span>Toggle</span></button><ul class="c-circle-menu__items"><li class="c-circle-menu__item"><a href="http://feeds.feedburner.com/UndergroundWebDev" target="_blank" rel="nofollow" title="Feed" class="c-circle-menu__link"><i class="icon fa fa-rss"></i></a></li><li class="c-circle-menu__item"><a href="https://github.com/caio-ribeiro-pereira" target="_blank" rel="nofollow" title="Github" class="c-circle-menu__link"><i class="icon fa fa-github"></i></a></li><li class="c-circle-menu__item"><a href="https://www.facebook.com/udgwebdev" target="_blank" rel="nofollow" title="Fanpage" class="c-circle-menu__link"><i class="icon fa fa-facebook-square"></i></a></li><li class="c-circle-menu__item"><a href="http://twitter.com/crp_underground" target="_blank" rel="nofollow" title="Twitter" class="c-circle-menu__link"><i class="icon fa fa-twitter-square"></i></a></li><li class="c-circle-menu__item"><a href="https://www.linkedin.com/in/caioribeiropereira" target="_blank" rel="nofollow" title="LinkedIn" class="c-circle-menu__link"><i class="icon fa fa-linkedin-square"></i></a></li></ul><div class="c-circle-menu__mask js-menu-mask"></div></nav><main role="main" class="container vertical-centralization"><div class="row"><article id="realtime-com-rethinkdb" class="col-xs-12 col-sm-9 post"><h1>Realtime com RethinkDB</h1><p class="text-muted">Publicação: <time datetime="19/07/2016" pubdate><b>19/07/2016</b></time> | Tags: <a href="/menu/#node.js" rel="me" title="Menu: Node.js">Node.js</a>, <a href="/menu/#nosql" rel="me" title="Menu: NoSQL">NoSQL</a></p><p><img src="/images/rethinkdb-logo.png" alt="Realtime com RethinkDB" title="Realtime com RethinkDB"></p>
<p>Se você precisa de um banco NoSQL que trabalhe com JSON, tenha suporte a consultas realtime e você quer expandir seus horizontes em conhecimentos que vão além de trabalhar apenas com MongoDB, uma boa opção é conhecer o RethinkDB.</p>
<p>RethinkDB é um banco open-source, que trabalha com dados JSON, porém ele organiza os dados em tabelas igual um banco SQL tradicional, permitindo também realizar consultas entre várias tabelas através do clássico comando join. Ele também oferece persistência de arrays e sub-documentos dentro de um registro, que é algo muito utilizado no MongoDB e CouchDB, que também é muito útil quando pretende persistir dados complexos em uma única tabela, ao invés de fazer joins entre múltiplas tabelas.</p>
<p>Abaixo veja algumas características legais do RethinkDB:</p>
<ul>
<li>Suporte Geospartial;</li>
<li>API para tratamento de Strings, Dates, Booleans e Documentos (objetos);</li>
<li>API para realizar cálculos matemáticos;</li>
<li>Map-reduce;</li>
<li>Possui cliente HTTP</li>
<li>Dashboard admin de databases via <a href="http://localhost:8080">localhost:8080</a></li>
<li>Consulta via streaming realtime através do changefeeds;</li>
<li>Criação de index simples, index composto e multi index (baseado em arrays);</li>
</ul>
<p>Partindo para o lado prático, que tal criarmos uma simples aplicação usando RethinkDB? Para explorarmos o suporte changefeed de consultas realtime, vamos criar uma simples timeline, em que todo mundo posta mensagens para uma timeline global.</p>
<p><strong>Atenção:</strong> Em primeiro lugar, é necessário que você tenha em sua máquina o RethinkDB instalado e rodando corretamente para em seguida criarmos o projeto abaixo, caso não tenha instalado, recomendo que você <a href="http://rethinkdb.com/docs/install/">siga as instruções do site oficial do RethinkDB</a>, afinal lá tem um vasto tutorial para instalação em diversos sistemas operacionais</p>
<p>Para começar o projeto, rode os seguintes comandos no seu terminal:</p>
<pre><code class="language-bash"> mkdir timeline
 cd timeline
 npm init
</code></pre>
<p>Responda como quiser as perguntas do <code>npm init</code>, afinal será usado apenas para criar o <code>package.json</code>, em seguida instale as seguintes dependências:</p>
<pre><code class="language-bash"> npm install --save express socket.io rethinkdb
</code></pre>
<p>Agora mãos a obra! Como será uma aplicação simples, vamos codar todo projeto em um único arquivo e <strong>usaremos algumas features do ES6 nativas do Node v6.x</strong>. Caso precise um projeto bem estruturado que utilize RethinkDB + Express como base para seus novos projetos, recentemente criei novo projetinho chamado <a href="https://github.com/caio-ribeiro-pereira/node-api-examples">node-api-examples</a> que é um conjunto de APIs simples e bem estruturada, em que cada projeto tem usa uma variação de web router e banco de dados, lá temos algumas versões de APIs usando RethinkDB com Express, Koa.js e Hapi.js. Da uma olhada lá!
Voltando ao foco desse post, crie o <code>index.js</code> da seguinte maneira:</p>
<pre><code class="language-javascript"> const http = require(&#39;http&#39;);
 const fs = require(&#39;fs&#39;);
 const express = require(&#39;express&#39;);
 const socketIO = require(&#39;socket.io&#39;);
 const r = require(&#39;rethinkdb&#39;);
 const config = require(&#39;./config.json&#39;);
 // Carregando Express, HTTP, SocketIO e DB config
 const db = Object.assign(config.rethinkdb, { db: &#39;timeline&#39; });
 const app = express();
 const server = http.Server(app);
 const io = socketIO(server);
 r.connect(db)
   .then(conn =&gt; {
     // Rota para carregar pagina inicial
     app.get(&#39;/&#39;, (req, res) =&gt; {
       fs.readFile(`${__dirname}/index.html`, (err, html) =&gt; {
         res.end(html || err);
       });
     });
     // Listando novas mensagens via changefeed + socket.io
     r.table(&#39;messages&#39;)
       .changes()
       .run(conn)
       .then(cursor =&gt; {
         cursor.each((err, data) =&gt; {
           const message = data.new_val;
           io.sockets.emit(&#39;/messages&#39;, message);
         });
       })
     ;
     // Cadastro de novas mensagens via socket.io
     io.on(&#39;connection&#39;, (client) =&gt; {
       r.table(&#39;messages&#39;)
         .run(conn)
         .then(cursor =&gt; {
           cursor.each((err, message) =&gt; {
             io.sockets.emit(&#39;/messages&#39;, message);
           });
         })
       ;
       client.on(&#39;/messages&#39;, (body) =&gt; {
         const { name, message } = body;
         const data = { name, message, date: new Date() };
         r.table(&#39;messages&#39;).insert(data).run(conn);
       });
     });
     server.listen(3000, () =&gt; console.log(&#39;Timeline Server!&#39;));
   })
   .error(err =&gt; {
     console.log(&#39;Erro ao se conectar com rethinkdb&#39;);
     throw err;
   })
 ;
</code></pre>
<p>Alguns detalhes são importantes saber quando vai trabalhar com RethinkDB
Em primeiro lugar, praticamente grande parte das funções desse módulo é baseado em <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> e nisso vai te permitir escrever um código assícrono mais estruturado e com melhor controle no tratamento de erros.</p>
<p>A query que realiza um <a href="http://rethinkdb.com/docs/changefeeds/javascript/">changefeed</a> é praticamente um subscriber do banco, em que registra uma query observadora para retornar qualquer alteração de dados de uma tabela, a combinação disso junto com a função <code>io.sockets.emit()</code> vai permitir que a aplicação retorne dados em tempo real para o cliente.</p>
<p>Para preparar o banco de dados dessa aplicação, vamos criar um simples script que cria database e tables para usarmos nesse projeto, crie o arquivo <code>database.js</code> da seguinte maneira:</p>
<pre><code class="language-javascript"> const r = require(&#39;rethinkdb&#39;);
 const config = require(&#39;./config.json&#39;);
 let conn;
 r.connect(config.rethinkdb)
   .then(connection =&gt; {
     console.log(&#39;Conectado no RethinkDB...&#39;);
     conn = connection;
     return r.dbCreate(&#39;timeline&#39;).run(conn);
   })
   .then(() =&gt; {
     console.log(&#39;Database &quot;timeline&quot; criado com sucesso!&#39;);
     return r.db(&#39;timeline&#39;).tableCreate(&#39;messages&#39;).run(conn);
   })
   .then(() =&gt; console.log(&#39;Tabela &quot;messages&quot; criada com sucesso!&#39;))
   .error(err =&gt; console.log(err))
   .finally(() =&gt; process.exit(0))
 ;
</code></pre>
<p>Em seguida, crie também o arquivo <code>config.json</code> que vai conter dados de conexão com banco RethinkDB:</p>
<pre><code class="language-javascript"> {
   &quot;rethinkdb&quot;: {
     &quot;host&quot;: &quot;localhost&quot;,
     &quot;port&quot;: 28015
   }
 }
</code></pre>
<p>Para finalizar nossa aplicação, crie a página <code>index.html</code> que será a interface da timeline para os usuários brincarem:</p>
<pre><code class="language-html"> &lt;!DOCTYPE html&gt;
 &lt;html&gt;
   &lt;head&gt;
     &lt;meta charset=&quot;utf-8&quot;&gt;
     &lt;title&gt;Timeline&lt;/title&gt;
     &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1&quot;&gt;
     &lt;script src=&quot;/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;
   &lt;/head&gt;
   &lt;body&gt;
     &lt;form style=&quot;text-align:center;margin:50px 0&quot;&gt;
       &lt;label for=&quot;name&quot;&gt;Nome:&lt;/label&gt;
       &lt;input type=&quot;text&quot; id=&quot;name&quot;/&gt;
       &lt;label for=&quot;message&quot;&gt;Mensagem:&lt;/label&gt;
       &lt;input type=&quot;text&quot; id=&quot;message&quot;/&gt;
       &lt;button type=&quot;submit&quot;&gt;Enviar&lt;/button&gt;
     &lt;/form&gt;
     &lt;fieldset style=&quot;padding: 20px;width:50%;margin:0 auto&quot;&gt;
       &lt;legend style=&quot;text-align:center&quot;&gt;Timeline&lt;/legend&gt;
       &lt;p id=&quot;messages&quot;&gt;&lt;/p&gt;
     &lt;/fieldset&gt;
     &lt;script&gt;
       (function() {
         var socket = io();
         var form = document.querySelector(&#39;form&#39;);
         form.addEventListener(&#39;submit&#39;, function(e) {
           e.preventDefault();
           var name = e.target.querySelector(&#39;#name&#39;);
           var message = e.target.querySelector(&#39;#message&#39;);
           var data = {
             name: name.value,
             message: message.value
           };
           socket.emit(&#39;/messages&#39;, data);
           e.target.reset();
         });
         socket.on(&#39;/messages&#39;, function(data) {
           var messages = document.querySelector(&#39;#messages&#39;);
           var message = &#39;&lt;b&gt;&#39;+ data.name +&#39;:&lt;/b&gt; &#39;+ data.message +&#39;&lt;br /&gt;&#39;;
           messages.innerHTML += message;
         });
       })();
     &lt;/script&gt;
   &lt;/body&gt;
 &lt;/html&gt;
</code></pre>
<p>Pronto! Finalizamos a implementação de nossa timeline! Agora falta rodar a aplicação, para isso, na primeira vez será necessário rodar os scripts de preparação do database do projeto, então rode:</p>
<pre><code class="language-bash"> node database.js
</code></pre>
<p>Se tudo estiver, ok! Então você já pode iniciar o server rodando comando:</p>
<pre><code class="language-bash"> node index.js
</code></pre>
<p>E brincar com sua nova aplicação realtime acessando <a href="http://localhost:3000">http://localhost:3000</a>.</p>
<p>See ya!</p><div id="disqus_thread"></div><script async="async" defer="defer">(function() {
  var disqus_shortname = 'udgwebdev';
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Por favor, habilite o JavaScript no seu browser para visualizar os comentários deste post.</noscript><script type="application/ld+json">{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Realtime com RethinkDB",
  "image": "https://udgwebdev.com/images/rethinkdb-logo.png",
  "publisher": "Underground WebDev",
  "url": "https://udgwebdev.com/realtime-com-rethinkdb",
  "datePublished": "2016-07-19",
  "dateCreated": "2016-07-19",
  "description": "Se você precisa de um banco NoSQL que trabalhe com JSON, tenha suporte a consultas realtime e você quer expandir seus horizontes em conhecimentos que vão além de trabalhar apenas com MongoDB, uma boa opção é conhecer o RethinkDB.",
  "author": {
    "@type": "Person",
    "name": "Caio Ribeiro Pereira"
  }
}</script></article></div></main><footer class="footer text-center"><p><small><i class="fa fa-trophy"></i>&nbsp;Powered by <a href="https://pages.github.com" rel="nofollow" target="_blank" title="Github Pages">Github Pages</a>, <a href="http://gruntjs.com" rel="nofollow" target="_blank" title="Grunt">Grunt</a> and <a href="http://harpjs.com" rel="nofollow" target="_blank" title="Harp.js">Harp.js</a>.</small><br/><small>Autor: <a href="https://crpwebdev.github.io" rel="me" target="_blank" title="Caio Ribeiro Pereira">Caio Ribeiro Pereira</a>.</small></p></footer><script src="/assets/js/circlemenu.min.js"></script><script src="/assets/js/main.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-25728091-2', 'auto');
ga('send', 'pageview');</script></body></html>